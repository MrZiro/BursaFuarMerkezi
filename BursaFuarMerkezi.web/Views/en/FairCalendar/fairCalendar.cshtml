@using System.Globalization
@model BursaFuarMerkezi.Models.ViewModels.FairCalendarViewModel
@{
    var culture = new CultureInfo("en-US");
    var fairsByMonth = Model.Fairs
        .SelectMany(f =>
        {
            var dates = new List<DateTime>();
            for (var date = f.StartDate.Date; date <= f.EndDate.Date; date = date.AddDays(1))
            {
                dates.Add(date);
            }
            return dates.Select(d => new { Fair = f, Date = d });
        })
        .GroupBy(x => new DateTime(x.Date.Year, x.Date.Month, 1))
        .OrderBy(g => g.Key);
    
    var fairsByWeek = Model.Fairs
        .GroupBy(f => CultureInfo.InvariantCulture.Calendar.GetWeekOfYear(f.StartDate, CalendarWeekRule.FirstDay, DayOfWeek.Monday))
        .OrderBy(g => g.First().StartDate);
}
@section Styles{
    <link href="/css/fuar-takvimi.css" rel="stylesheet"/>
}
@section Scripts{
    <script src="/js/fuar-takvimi.js"></script>
}

<div class="banner">
</div>

<div class="container">
    <header class="view-header">
        <h1 class="mt-4">
            Fair Calendar
        </h1>
        <div class="view-buttons">
            <button class="view-btn active" data-view="list">
                List View
            </button>
            <button class="view-btn" data-view="monthly">
                Monthly View
            </button>
            <button class="view-btn" data-view="weekly">
                Weekly View
            </button>
        </div>
    </header>
    <div class="search-container">
        <input id="searchInput" placeholder="Search..." type="text"/>
        <span class="search-icon">
            üîç
        </span>
    </div>
    <div class="content-container">
        <div class="view-content active" id="listView">
            <!-- List View -->
            <div class="fair-list">
                @if (Model.Fairs != null && Model.Fairs.Any())
                {
                    @foreach (var fair in Model.Fairs)
                    {
                        <div class="fair-item">
                            <div class="fair-date">
                                <span class="day">@fair.StartDate.ToString("dd")</span>
                                <span class="month">@fair.StartDate.ToString("MMMM", culture)</span>
                                <span class="year">@fair.StartDate.Year</span>
                            </div>
                            <div class="fair-details">
                                <h3>
                                    <a href="/en/fair-detail/@fair.SlugEn">@fair.TitleEn</a>
                                </h3>
                                <p class="location">
                                    <strong>Location:</strong> @fair.FairLocationEn
                                </p>
                                <p class="description">
                                    @fair.SubTitleEn
                                </p>
                                <div class="fair-tags">
                                    @foreach (var sector in fair.Sectors)
                                    {
                                        <span class="tag">@sector.NameEn</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p>No fairs to display.</p>
                }
            </div>
        </div>
        <div class="view-content" id="monthlyView">
            <!-- Monthly View -->
            @if (fairsByMonth.Any())
            {
                @foreach (var monthGroup in fairsByMonth)
                {
                    var monthStart = monthGroup.Key;
                    var daysInMonth = DateTime.DaysInMonth(monthStart.Year, monthStart.Month);
                    var firstDayOfMonth = new DateTime(monthStart.Year, monthStart.Month, 1);
                    int startDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
                    if (startDayOfWeek == 0) startDayOfWeek = 7; // Sunday = 7
                    startDayOfWeek--; // Monday = 0

                    <div class="monthly-calendar">
                        <div class="month-header">
                            <h2>@monthStart.ToString("MMMM yyyy", culture)</h2>
                        </div>
                        <div class="month-grid">
                            <div class="weekdays">
                                <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                            </div>
                            <div class="days">
                                @for (int i = 0; i < startDayOfWeek; i++)
                                {
                                    <div class="day empty"></div>
                                }
                                @for (int day = 1; day <= daysInMonth; day++)
                                {
                                    var currentDate = new DateTime(monthStart.Year, monthStart.Month, day);
                                    var fairsOnDay = monthGroup.Where(x => x.Date.Date == currentDate.Date).Select(x => x.Fair).Distinct().ToList();
                                    if (fairsOnDay.Any())
                                    {
                                        <div class="day has-event">
                                            @day
                                            <div class="event-indicator"></div>
                                            <div class="event-popup">
                                                @foreach (var fair in fairsOnDay)
                                                {
                                                    <p><strong>@fair.TitleEn</strong></p>
                                                    <p>@fair.FairLocationEn</p>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="day">@day</div>
                                    }
                                }
                            </div>
                        </div>
                        <div class="month-events">
                            <h3>Fairs This Month</h3>
                            @foreach (var fair in monthGroup.Select(x => x.Fair).Distinct().OrderBy(f => f.StartDate))
                            {
                                <div class="month-event-item">
                                    <div class="event-date">
                                        @fair.StartDate.ToString("dd MMMM yyyy", culture) - @fair.EndDate.ToString("dd MMMM yyyy", culture)
                                    </div>
                                    <div class="event-details">
                                        <h3><strong>@fair.TitleEn</strong></h3>
                                        <p>@fair.FairLocationEn</p>
                                        <p>@string.Join(", ", fair.Sectors.Select(s => s.NameEn))</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <p>No fairs to display.</p>
            }
        </div>
        <div class="view-content" id="weeklyView">
            <!-- Weekly View -->
            @if (fairsByWeek.Any())
            {
                @foreach (var weekGroup in fairsByWeek)
                {
                    var firstFairInWeek = weekGroup.First();
                    var startDateOfWeek = firstFairInWeek.StartDate.AddDays(-(int)firstFairInWeek.StartDate.DayOfWeek + (int)DayOfWeek.Monday);
                    if (startDateOfWeek > firstFairInWeek.StartDate) startDateOfWeek = startDateOfWeek.AddDays(-7);
                    
                    var endDateOfWeek = startDateOfWeek.AddDays(6);
                    var weekHeader = $"{startDateOfWeek.ToString("dd MMM", culture)} - {endDateOfWeek.ToString("dd MMM yyyy", culture)}";

                    <div class="weekly-calendar">
                        <div class="week-header">
                            <h2>@weekHeader</h2>
                        </div>
                        <div class="week-grid">
                            @for (int i = 0; i < 7; i++)
                            {
                                var day = startDateOfWeek.AddDays(i);
                                var fairsOnDay = Model.Fairs.Where(f => day.Date >= f.StartDate.Date && day.Date <= f.EndDate.Date).ToList();

                                <div class="day-column @(fairsOnDay.Any() ? "has-event" : "")">
                                    <div class="day-header">@day.ToString("dddd", culture)</div>
                                    <div class="day-date">@day.ToString("dd MMMM", culture)</div>
                                    <div class="day-events">
                                        @if (fairsOnDay.Any())
                                        {
                                            @foreach (var fair in fairsOnDay)
                                            {
                                                <div class="week-event">
                                                    <h4>@fair.TitleEn</h4>
                                                    <p>@fair.VisitingHours</p>
                                                    <p>@fair.FairLocationEn</p>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <p>No fair</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                 <p>No fairs to display.</p>
            }
        </div>
    </div>
</div>

